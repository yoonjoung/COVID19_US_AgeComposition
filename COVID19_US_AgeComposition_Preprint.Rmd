---
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
---
```{r intro, echo=FALSE, results="hide"}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE, 
                      comment = "", 
                      warning=FALSE, 
                      results="hide") 
knitr::opts_knit$set(root.dir = "C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/")

date<-as.Date(Sys.time(	), format='%d%b%Y')
time<-Sys.time()

suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(ggplot2)))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(readxl)))
suppressWarnings(suppressMessages(library(plotly)))
suppressWarnings(suppressMessages(library(Matrix)))
suppressWarnings(suppressMessages(library(stringr)))
suppressWarnings(suppressMessages(library(stringi)))

suppressWarnings(suppressMessages(library(jsonlite)))
suppressWarnings(suppressMessages(library(httr)))
suppressWarnings(suppressMessages(library(rlist)))
suppressWarnings(suppressMessages(library(zoo)))
suppressWarnings(suppressMessages(library(RColorBrewer))) 
suppressWarnings(suppressMessages(library(lubridate)))
```

```{r dataPop}
# https://www.census.gov/newsroom/press-kits/2020/population-estimates-detailed.html
# Annual Estimates of the Resident Population by Sex, Age, Race, and Hispanic Origin for the United States: April 1, 2010 to July 1, 2019
# NC-EST2019-ASR6H

dtapop<-read.csv("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataCensusBureau/nc-est2019-asr6h-2019.csv")
names(dtapop)<- tolower(names(dtapop))
    colnames(dtapop) 
    table(dtapop$race) 
    table(dtapop$hispanicorigin) 
 
    #View(dtapop)

dtapopage<-dtapop%>%
    filter(sex=="Total")%>%
    filter(race=="Total")%>%
    filter(hispanicorigin=="Total")%>%
    select(race, hispanicorigin, sex, starts_with("age"), pop)%>%
    filter(agegroup_5=="yes")

    sum(dtapopage$pop)

dtapopage10<-dtapopage%>%
    mutate(
        age=ifelse(age== 5,  0, age),
        age=ifelse(age==15, 10, age),
        age=ifelse(age==25, 20, age),
        age=ifelse(age==35, 30, age),
        age=ifelse(age==45, 40, age),
        age=ifelse(age==55, 50, age),
        age=ifelse(age==65, 60, age),
        age=ifelse(age==75, 70, age),
        age=ifelse(age==85, 80, age)
    )%>%
    group_by(race, hispanicorigin, sex, age)%>%
    summarise_at(vars(pop), funs(sum))
    
    sum(dtapopage10$pop)

dtapopagerace<-dtapop%>%
    filter(sex=="Total")%>%
    filter(race!="Total")%>%
    filter(hispanicorigin!="Total")%>%
    select(race, hispanicorigin, sex, starts_with("age"), pop)%>%
    filter(agegroup_5=="yes")%>%
    mutate(
        racegroup="", 
        racegroup=ifelse((race=="White" & hispanicorigin=="Not Hispanic"),
                         "NH White", racegroup), 
        racegroup=ifelse((race=="Black" & hispanicorigin=="Not Hispanic"),
                         "NH Black", racegroup), 
        racegroup=ifelse((race=="Asian" & hispanicorigin=="Not Hispanic"),
                         "NH Asian", racegroup), 
        racegroup=ifelse((race=="AIAN" & hispanicorigin=="Not Hispanic"),
                         "NH AIAN", racegroup), 
        racegroup=ifelse((race=="NHPI" & hispanicorigin=="Not Hispanic"),
                         "NH NHPI", racegroup), 
        racegroup=ifelse((race=="TwoOrMoreRaces" & hispanicorigin=="Not Hispanic"),
                         "NH Multiple/Other", racegroup), 
        racegroup=ifelse((hispanicorigin=="Hispanic"),
                         "Hispanic", racegroup)
    )%>%
    select(racegroup, starts_with("age"), pop)%>%
    group_by(racegroup, age, agegroup)%>%
    summarise_at(vars(pop), funs(sum))%>%
    ungroup()

    sum(dtapopagerace$pop)
    
dtapopagerace10<-dtapopagerace%>%
    mutate(
        age=ifelse(age== 5,  0, age),
        age=ifelse(age==15, 10, age),
        age=ifelse(age==25, 20, age),
        age=ifelse(age==35, 30, age),
        age=ifelse(age==45, 40, age),
        age=ifelse(age==55, 50, age),
        age=ifelse(age==65, 60, age),
        age=ifelse(age==75, 70, age),
        age=ifelse(age==85, 80, age)
    )%>%
    group_by(racegroup, age)%>%
    summarise_at(vars(pop), funs(sum))    

    sum(dtapopagerace10$pop)

```

```{r CaseSurveillanceExport}

# COVID-19 Case Surveillance Public Use (case level)
# https://data.cdc.gov/Case-Surveillance/COVID-19-Case-Surveillance-Public-Use-Data/vbim-akqf

    ##### Export to CSV
    
dtasurveillance<-read.csv("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataCDC/COVID-19_Case_Surveillance_Public_Use_Data.csv")    
    names(dtasurveillance)<- tolower(names(dtasurveillance))
    colnames(dtasurveillance)
    nrow(dtasurveillance)

    #table(dtasurveillance$current_status)
    #table(dtasurveillance$age_group)
    #table(dtasurveillance$sex)
    #table(dtasurveillance$race.and.ethnicity..combined.)
    #table(dta$onset_dt)  
    #table(dta$pos_spec_dt)
    #table(dta$cdc_report_dt)    
    
# OMG age categories different for the case surveillance and tabulated death count data! 
# If we want to use same categoreis for cases and deaths, we must use the surveillance data. Ugh...
# Get pop data readu accordingly 10- year interval
```

```{r dta}
# CASE LEVEL data managment         
dta<-dtasurveillance%>%
    mutate_if(is.factor, as.character) %>% 
    mutate(
        
        cdc_report_dt=as.POSIXct(as.Date(cdc_report_dt)),
        week=as.numeric(strftime(cdc_report_dt, format = "%V")),
        
        sextotal="Total",
        
        agegroup=age_group, 
            agegroup=ifelse(is.na(agegroup)==TRUE, "Unknown", agegroup),
        age=as.numeric(sapply(strsplit(agegroup,"-"), `[`, 1)), #age interval begins
            age=ifelse(agegroup=="80+ Years", 80, age),
        
        racegroup=race.and.ethnicity..combined., 
        racegroup=ifelse(race.and.ethnicity..combined.=="White, Non-Hispanic",
                         "NH White", racegroup), 
        racegroup=ifelse(race.and.ethnicity..combined.=="Black, Non-Hispanic",
                         "NH Black", racegroup), 
        racegroup=ifelse(race.and.ethnicity..combined.=="Asian, Non-Hispanic",
                         "NH Asian", racegroup), 
        racegroup=ifelse(race.and.ethnicity..combined.=="American Indian/Alaska Native, Non-Hispanic",
                         "NH AIAN", racegroup), 
        racegroup=ifelse(race.and.ethnicity..combined.=="Native Hawaiian/Other Pacific Islander, Non-Hispanic",
                         "NH NHPI", racegroup), 
        racegroup=ifelse(race.and.ethnicity..combined.=="Multiple/Other, Non-Hispanic",
                         "NH Multiple/Other", racegroup), 
        racegroup=ifelse(race.and.ethnicity..combined.=="Hispanic/Latino",
                         "Hispanic", racegroup),
        racegroup=ifelse(is.na(race.and.ethnicity..combined.)==TRUE,
                         "Unknown", racegroup),
        
        raceagegroup=paste0(racegroup, "_",agegroup), 

        missingage  =as.numeric(is.na(age)==TRUE),
        missingsex  =as.numeric(sex!="Male" & sex!="Female" ),
        missingrace =as.numeric(racegroup=="Unknown"),
        missingdeath=as.numeric(death_yn!="Yes" & death_yn!="No"),  
        missinghosp =as.numeric(hosp_yn!="Yes" & hosp_yn!="No"),
        
        case=1, 
        death=as.numeric(death_yn=="Yes"), 
        hosp =as.numeric(hosp_yn=="Yes"), 
        
            death=ifelse(missingdeath==1, NA, death), 
            hosp =ifelse(missinghosp ==1, NA, hosp)
        
        )

colnames(dta)    
str(dta)
summary(dta)

table(dta$raceagegroup)


```

```{r dtaweekly}
# Weekly trend count data by RACE AND AGE
dtaweekly<-dta%>%
    arrange(racegroup, agegroup, week)%>%
    mutate(raceagegroupweek=paste0(racegroup,"_",agegroup,"_",as.character(week)))%>%
    group_by(raceagegroupweek)%>%
    summarise_at(vars(case, death, hosp, missingdeath, missinghosp), funs(sum), na.rm = TRUE)%>%
    ungroup()%>%
    mutate(
        racegroup=sapply(strsplit(raceagegroupweek,"_"), `[`, 1),
        agegroup=sapply(strsplit(raceagegroupweek,"_"), `[`, 2),
        week=as.numeric(sapply(strsplit(raceagegroupweek,"_"), `[`, 3)), 
        
        age=as.numeric(sapply(strsplit(agegroup,"-"), `[`, 1)), #age interval begins
            age=ifelse(agegroup=="80+ Years", 80, age), 
        
        raceagegroup=paste0(racegroup, "_", agegroup) 
        )%>%
    arrange(racegroup, agegroup, week)%>%
    mutate(
        case_lag1 =lag(case), 
        case_lag2 =lag(case_lag1), 
        case_lag3 =lag(case_lag2), 
            test1=raceagegroup!=lag(raceagegroup),
            test2=lag(test1)==TRUE, 
            test3=lag(test2)==TRUE, 
            case_lag1 = ifelse(test1==TRUE, NA, case_lag1),
            case_lag2 = ifelse(test1==TRUE, NA, case_lag2),    
            case_lag2 = ifelse(test2==TRUE, NA, case_lag2),
            case_lag3 = ifelse(test1==TRUE, NA, case_lag3),
            case_lag3 = ifelse(test2==TRUE, NA, case_lag3),
            case_lag3 = ifelse(test3==TRUE, NA, case_lag3),
        cfr_lag1=round(100*death/case_lag1, 2), 
        cfr_lag2=round(100*death/case_lag2, 2), 
        cfr_lag3=round(100*death/case_lag3, 2) 
        )%>%
    select(-test1, -test2, -test3)

    #nrow(dtaweekly)
    #str(dtaweekly)
    #summary(dtaweekly)

dim(dtaweekly)
dtaweekly<-left_join(dtaweekly, dtapopagerace10, by = c("racegroup", "age")) 
dim(dtaweekly)    

```

```{r dtaweeklycum}
# Weekly trend count data by RACE AND AGE
dtaweeklycum<-dtaweekly%>%
    arrange(racegroup, agegroup, week)%>%
    group_by(raceagegroup)%>%
    mutate(
        cumcase =cumsum(case),   
        cumdeath=cumsum(death), 
        cumhosp =cumsum(hosp)
    )%>%
    ungroup()%>%
    arrange(racegroup, agegroup, week)

colnames(dtaweeklycum)

    #nrow(dtaweekly)
    #str(dtaweekly)
    #summary(dtaweekly)

```

##__Annex for a pre-print manuscript, "Trends in age distribution of COVID-19 cases, hospitalizations, and deaths by race in the United States"__##

Madeleine Short Fabic and Yoonjoung Choi

(Updated: `r time` EDT)  

* Data source: [COVID-19 Case Surveillance Public Use Data](https://data.cdc.gov/Case-Surveillance/COVID-19-Case-Surveillance-Public-Use-Data/vbim-akqf)    
* Accessed on December 25, 2020 (version released on December 4, 2020)
* The pre-print is available here: [10.31235/osf.io/7edgu](https://osf.io/preprints/socarxiv/7edgu/)

```{r overall_plotracecomposition_trendDTA}

temp1 <- dtaweekly%>%select(week, case)%>%
    group_by(week)%>%summarize_all(funs(sum))%>%ungroup()%>%
    mutate(
        total=case
    )%>%
    select(-case)

temp2 <- dtaweekly%>%
    mutate(racegroupweek=paste0(racegroup,"_",as.character(week)))%>%
    select(racegroupweek, case)%>%
    group_by(racegroupweek)%>%summarize_all(funs(sum))%>%ungroup()%>%
    mutate(
        racegroup=sapply(strsplit(racegroupweek,"_"), `[`, 1), 
        week=as.numeric(sapply(strsplit(racegroupweek,"_"), `[`, 2))
    )

    dim(temp1)
    dim(temp2)

dtafig<-left_join(temp2, temp1, by = "week")%>% 
    mutate(
        pct=round(100*case/total,1)
    )

first.day <- as.numeric(format(as.Date("2020-01-01"), "%w"))
dtafig$weekdate<-as.Date("2020-01-01") + dtafig$week * 7 - first.day


sum(dta$case)
sum(dtaweekly$case)
sum(dtafig$case)
```

```{r overall_plotracecomposition_trend2, fig.align="left", out.width="800px", out.height="300px"}

dtafig1<-dtafig%>%
    filter(total>20)%>%
    select(weekdate, pct, racegroup)

fig1<-dtafig1%>%    
    plot_ly(x=~weekdate,
            y = ~pct, type = "bar",
            color= ~racegroup , 
            colors = c('#74c476',
                       '#e31a1c',
                       '#fed976',
                       '#feb24c',
                       '#fd8d3c',
                       '#fc4e2a',
                       '#6baed6',
                       'lightgray')
            )%>% 
    layout(
        title ="",
        yaxis = list(title = "Percent of reported cases per week",
                     titlefont=list(size=12)), 
        xaxis = list(title = ""),
        legend = list(font=list(size=10)),
        barmode = 'stack'
        ) 

fig1

```

###__Annex 1. Trends of age distribution in COVID-19 cases, hospitalizations, and deaths: by race__

```{r plotagecomposition_weeklytrendDTA}

#cases
temp1 <- dtaweekly%>%
    mutate(racegroupweek=paste0(racegroup,"_",as.character(week)))%>%
    select(racegroupweek, case)%>%
    group_by(racegroupweek)%>%summarize_all(funs(sum))%>%ungroup()%>%
    mutate(
        total=case
    )%>%
    select(-case)%>%
    mutate(
        racegroup=sapply(strsplit(racegroupweek,"_"), `[`, 1), 
        week=as.numeric(sapply(strsplit(racegroupweek,"_"), `[`, 2))
    )

temp2 <- dtaweekly%>%
    select(raceagegroupweek, case)%>%
    group_by(raceagegroupweek)%>%summarize_all(funs(sum))%>%ungroup()%>%
    mutate(
        racegroup=sapply(strsplit(raceagegroupweek,"_"), `[`, 1), 
        agegroup=sapply(strsplit(raceagegroupweek,"_"), `[`, 2),
        week=as.numeric(sapply(strsplit(raceagegroupweek,"_"), `[`, 3))
    )

    dim(temp1)
    dim(temp2)
    colnames(temp1)
    colnames(temp2)

tempcase<-left_join(temp2, temp1, by = c("racegroup", "week"))%>% 
    mutate(
        pct=round(100*case/total,1),
        group="Cases",
        count=case
    )%>%
    select(raceagegroupweek, racegroup, agegroup, week, total, pct, count, group) 

#hospitalizations
#hosp
temp1 <- dtaweekly%>%
    mutate(racegroupweek=paste0(racegroup,"_",as.character(week)))%>%
    select(racegroupweek, hosp)%>%
    group_by(racegroupweek)%>%summarize_all(funs(sum))%>%ungroup()%>%
    mutate(
        total=hosp
    )%>%
    select(-hosp)%>%
    mutate(
        racegroup=sapply(strsplit(racegroupweek,"_"), `[`, 1), 
        week=as.numeric(sapply(strsplit(racegroupweek,"_"), `[`, 2))
    )

temp2 <- dtaweekly%>%
    select(raceagegroupweek, hosp)%>%
    group_by(raceagegroupweek)%>%summarize_all(funs(sum))%>%ungroup()%>%
    mutate(
        racegroup=sapply(strsplit(raceagegroupweek,"_"), `[`, 1), 
        agegroup=sapply(strsplit(raceagegroupweek,"_"), `[`, 2),
        week=as.numeric(sapply(strsplit(raceagegroupweek,"_"), `[`, 3))
    )

    dim(temp1)
    dim(temp2)
    colnames(temp1)
    colnames(temp2)

temphosp<-left_join(temp2, temp1, by = c("racegroup", "week"))%>% 
    mutate(
        pct=round(100*hosp/total,1),
        group="hospitalizations",
        count=hosp
    )%>%
    select(raceagegroupweek, racegroup, agegroup, week, total, pct, count, group) 

#death
temp1 <- dtaweekly%>%
    mutate(racegroupweek=paste0(racegroup,"_",as.character(week)))%>%
    select(racegroupweek, death)%>%
    group_by(racegroupweek)%>%summarize_all(funs(sum))%>%ungroup()%>%
    mutate(
        total=death
    )%>%
    select(-death)%>%
    mutate(
        racegroup=sapply(strsplit(racegroupweek,"_"), `[`, 1), 
        week=as.numeric(sapply(strsplit(racegroupweek,"_"), `[`, 2))
    )

temp2 <- dtaweekly%>%
    select(raceagegroupweek, death)%>%
    group_by(raceagegroupweek)%>%summarize_all(funs(sum))%>%ungroup()%>%
    mutate(
        racegroup=sapply(strsplit(raceagegroupweek,"_"), `[`, 1), 
        agegroup=sapply(strsplit(raceagegroupweek,"_"), `[`, 2),
        week=as.numeric(sapply(strsplit(raceagegroupweek,"_"), `[`, 3))
    )

    dim(temp1)
    dim(temp2)
    colnames(temp1)
    colnames(temp2)

tempdeath<-left_join(temp2, temp1, by = c("racegroup", "week"))%>% 
    mutate(
        pct=round(100*death/total,1), 
        group="Deaths", 
        count=death
    )%>%
    select(raceagegroupweek, racegroup, agegroup, week, total, pct, count, group) 

# merge all three
dtafig<-rbind(tempcase, temphosp, tempdeath) 

first.day <- as.numeric(format(as.Date("2020-01-01"), "%w"))
dtafig$weekdate<-as.Date("2020-01-01") + dtafig$week * 7 - first.day

dim(dtafig)
str(dtafig)
```

```{r plotagecomposition_weeklytrend_pct}
panel <- . %>% 
    plot_ly(x=~weekdate,
            y = ~pct, type = "bar",
             color= ~agegroup, 
             colors = brewer.pal(length(unique(dtafig$agegroup)),
                                "Spectral")
             ) %>% 
    add_annotations(
        text = ~unique(racegroup),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%    
    layout(
        title ="",
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        xaxis = list(title = ""),
        legend = list(font=list(size=10)),
        barmode = 'stack'
        ) 
```

###__Annex1.1. Trends of age distribution in weekly cases__
```{r plotagecomposition_weeklytrend_case_pct, results="asis", fig.align="left", out.width="800px", out.height="800px"}
dtafig%>%
    filter(group=="Cases")%>%
    filter(total>20)%>%
    group_by(racegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 4, shareX = TRUE, shareY = FALSE, margin=0.05)%>%
    layout(
        yaxis=list(title = "% of weekly cases"), 
        xaxis=list(title = ""), 
        showlegend = FALSE
        )  

dtafig2case<-dtafig%>%
    filter(group=="Cases")%>%
    filter(total>20)%>%    
    filter(racegroup=="Hispanic" | racegroup=="NH Black" | racegroup=="NH White")%>%
    select(weekdate, pct, agegroup, racegroup)

fig2case<-dtafig2case%>%
    group_by(racegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE)%>%
    layout(
        yaxis=list(title = "% of weekly cases"), 
        xaxis=list(title = ""), 
        showlegend = FALSE
        ) 


```
(only weeks with more than 20 cases are presented)

###__Annex1.2. Trends of age distribution in weekly hospitalizations__
```{r plotagecomposition_weeklytrend_hosp_pct, results="asis", fig.align="left", out.width="800px", out.height="800px"}
dtafig%>%
    filter(group=="hospitalizations")%>%
    filter(total>20)%>%
    group_by(racegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 4, shareX = TRUE, shareY = FALSE, margin=0.05)%>%
    layout(
        yaxis=list(title = "% of weekly hospitalizations"), 
        xaxis=list(title = ""), 
        showlegend = FALSE
        )  


dtafig2hosp<-dtafig%>%
    filter(group=="hospitalizations")%>%
    filter(total>20)%>%
    filter(racegroup=="Hispanic" | racegroup=="NH Black" | racegroup=="NH White")%>%
    select(weekdate, pct, agegroup, racegroup)

fig2hosp<-dtafig2hosp%>%
    group_by(racegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE)%>%
    layout(
        yaxis=list(title = "% of weekly hospitalizations"), 
        xaxis=list(title = ""), 
        showlegend = FALSE
        )  
```
(only weeks with more than 20 hospitalizations are presented)

###__Annex1.3. Trends of age distribution in weekly deaths__
```{r plotagecomposition_weeklytrend_death_pct, results="asis", fig.align="left", out.width="800px", out.height="800px"}
dtafig%>%
    filter(group=="Deaths")%>%
    filter(total>20)%>%
    group_by(racegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 4, shareX = TRUE, shareY = FALSE, margin=0.05)%>%
    layout(
        yaxis=list(title = "% of weekly deaths"), 
        xaxis=list(title = ""), 
        showlegend = FALSE
        )  

dtafig2death<-dtafig%>%
    filter(group=="Deaths")%>%
    filter(total>20)%>%    
    filter(racegroup=="Hispanic" | racegroup=="NH Black" | racegroup=="NH White")%>%
    select(weekdate, pct, agegroup, racegroup)

fig2death<-dtafig2death%>%
    group_by(racegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE)%>%
    layout(
        yaxis=list(title = "% of weekly deaths"), 
        xaxis=list(title = ""), 
        showlegend = FALSE
        )  
```
(only weeks with more than 20 deaths are presented)

###__Annex1.4. Trends of lagged weekly case fatality ratio__
```{r}

panel <- . %>% 
    plot_ly(x=~weekdate, y=~cfr80, name = "80+", 
               type = 'scatter', mode='lines',
               line = list(color = c( '#3288bd')) )%>% 
    add_trace(y=~cfr70, name = "70-79", line = list(color = c( '#66c2a5'))) %>% 
    add_trace(y=~cfr60, name = "60-69", line = list(color = c( '#abdda4'))) %>% 
    add_trace(y=~cfr50, name = "50-59", line = list(color = c( '#e6f598'))) %>% 
    add_trace(y=~cfr40, name = "40-49", line = list(color = c( '#ffffbf'))) %>% 
    add_trace(y=~cfr30, name = "30-39", line = list(color = c( '#fee08b'))) %>% 
    add_trace(y=~cfr20, name = "20-29", line = list(color = c( '#fdae61'))) %>% 
    add_trace(y=~cfr10, name = "10-19", line = list(color = c( '#f46d43'))) %>% 
    add_trace(y=~cfr0,  name = "0-9",   line = list(color = c( '#d53e4f'))) %>% 
    add_annotations(
        text = ~unique(racegroup),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%     
    layout(
        yaxis = list(type = "log", range = c(-2, 3) ), 
        xaxis = list(title = "", titlefont=list(size=8), tickfont=list(size=8)),
        legend = list(font=list(size=10)) 
        ) 
```

```{r fig3all, results="asis", fig.align="left", out.width="800px", out.height="800px"}

first.day <- as.numeric(format(as.Date("2020-01-01"), "%w"))

dtasorted<-dtaweekly %>%
    filter(is.na(age)==FALSE)%>% #drop cases with missing cases
    filter(week>=14)%>% # drop initial weeks
    select(week, age, racegroup, 
           starts_with("case"), starts_with("death"), starts_with("cfr")) %>%
    mutate(
        weekdate=as.Date("2020-01-01") + week * 7 - first.day, 
        age=paste0("cfr",age)
    ) %>%
    arrange(racegroup, weekdate, age)

dtasorted %>% 
    select(racegroup, weekdate, age, cfr_lag2)%>%
    spread(age, cfr_lag2, fill = NA, convert = FALSE) %>%
    group_by(racegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 4, shareX = TRUE, shareY = TRUE, margin=0.05)%>%
    layout(
        showlegend = FALSE,
        yaxis = list(title = "deaths / 2-week lagged cases (in 100)",
                     titlefont=list(size=12),
                     type = "log", range = c(-2, 3) ),
        xaxis=list(title = "") 
        )  


```

NH: Non-Hispanic, AIAN: American Indian/Alaskan Native, NHPI: Native Hawaiian/Other Pacific Islander. 
```{r fig1, out.width="800px", out.height="300px"}
## Figure 1. Trend of race-distribution in weekly COVID-19 cases
fig1

write.csv(dtafig1, "X_COVID19_US_AgeComposition/data_figure1.csv")

```

```{r fig2, out.width="800px", out.height="800px"}
## Figure 2. Trend of age-distribution in weekly COVID-19 cases, hospitalizations, and deaths by race/ethnicity: Hispanic, non-Hispanic black, vs. Non-Hispanic white 

subplot(
        fig2case %>% 
            layout(yaxis=list(title = "% of weekly cases", 
                              font=list(size=8)),
                   showlegend = FALSE), 
        fig2hosp %>% 
            layout(yaxis=list(title = "% of weekly hospitalizations",
                              font=list(size=8)),
                   showlegend = FALSE), 
        fig2death %>% 
            layout(yaxis=list(title = "% of weekly deaths", 
                              font=list(size=8))
                   ), 
        nrows=3, shareX = TRUE , shareY=FALSE, titleY = TRUE)

write.csv(dtafig2case, "X_COVID19_US_AgeComposition/data_figure2case.csv")
write.csv(dtafig2hosp, "X_COVID19_US_AgeComposition/data_figure2hospitalization.csv")
write.csv(dtafig2death, "X_COVID19_US_AgeComposition/data_figure2death.csv")
```